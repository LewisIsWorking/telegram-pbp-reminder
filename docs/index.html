<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Path Wars — PBP Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Source+Sans+3:wght@400;600&display=swap');
  :root {
    --bg: #0f1119; --surface: #1a1d2e; --surface-2: #232740;
    --border: #2e3350; --text: #c8cad8; --text-dim: #7a7e96;
    --accent: #d4a953; --gm: #6c8fd4; --player: #d46c8f;
    --green: #6cd4a0; --yellow: #d4c76c; --orange: #d4996c; --red: #d46c6c;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Source Sans 3',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
  header { text-align:center; padding:2rem 1rem 1rem; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#161929,var(--bg)); }
  header h1 { font-family:'Cinzel',serif; font-weight:700; font-size:1.6rem; color:var(--accent); letter-spacing:0.08em; }
  header p { color:var(--text-dim); margin-top:0.3rem; font-size:0.9rem; }
  .ctr { max-width:1100px; margin:0 auto; padding:1.2rem 1rem; }

  .summary-row { display:grid; grid-template-columns:repeat(4,1fr); gap:0.8rem; margin-bottom:1.2rem; }
  .scard { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:0.9rem; text-align:center; }
  .scard .val { font-size:1.7rem; font-weight:700; color:var(--accent); font-variant-numeric:tabular-nums; }
  .scard .lbl { font-size:0.75rem; color:var(--text-dim); margin-top:0.15rem; text-transform:uppercase; letter-spacing:0.05em; }

  .filter-bar { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; align-items:center; }
  .filter-bar label { color:var(--text-dim); font-size:0.85rem; }
  .filter-bar select { background:var(--surface-2); color:var(--text); border:1px solid var(--border); border-radius:4px; padding:0.3rem 0.5rem; font-size:0.85rem; font-family:inherit; }

  .grid { display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; margin-bottom:1.2rem; }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:1rem; }
  .card.full { grid-column:1/-1; }
  .card h2 { font-family:'Cinzel',serif; font-size:0.9rem; color:var(--accent); margin-bottom:0.7rem; font-weight:500; letter-spacing:0.04em; }
  .chart-wrap { position:relative; height:250px; }
  .legend-note { font-size:0.72rem; color:var(--text-dim); margin-top:0.3rem; text-align:center; }

  table { width:100%; border-collapse:collapse; font-size:0.82rem; }
  thead th { text-align:left; padding:0.4rem 0.5rem; border-bottom:2px solid var(--border); color:var(--text-dim); font-weight:600; cursor:pointer; user-select:none; white-space:nowrap; font-size:0.78rem; }
  thead th:hover { color:var(--accent); }
  thead th.sorted { color:var(--accent); }
  thead th .arrow { font-size:0.6rem; margin-left:0.2rem; }
  tbody td { padding:0.4rem 0.5rem; border-bottom:1px solid var(--border); }
  tbody tr:hover { background:var(--surface-2); }
  tbody tr.xp { cursor:pointer; }
  tbody tr.xp td:first-child::before { content:'▸ '; color:var(--text-dim); font-size:0.7rem; }
  tbody tr.xp.open td:first-child::before { content:'▾ '; color:var(--accent); }
  tbody tr.pr { background:var(--surface-2); font-size:0.78rem; }
  tbody tr.pr td { padding:0.25rem 0.5rem 0.25rem 1.6rem; color:var(--text-dim); }
  tbody tr.pr td:first-child { color:var(--text); }
  .cn { font-weight:600; }
  .num { text-align:right; font-variant-numeric:tabular-nums; }
  .tu { color:var(--green); } .td { color:var(--red); } .tf { color:var(--text-dim); }
  .h { display:inline-block; width:7px; height:7px; border-radius:50%; margin-right:0.35rem; }
  .hg { background:var(--green); } .hy { background:var(--yellow); } .ho { background:var(--orange); } .hr { background:var(--red); }

  #loading { text-align:center; padding:4rem; color:var(--text-dim); }
  #error { text-align:center; padding:2rem; color:var(--red); display:none; }
  @media(max-width:768px) { .grid{grid-template-columns:1fr;} .summary-row{grid-template-columns:repeat(2,1fr);} header h1{font-size:1.3rem;} .scard .val{font-size:1.3rem;} }
  @media(max-width:480px) { .ctr{padding:0.7rem 0.5rem;} table{font-size:0.75rem;} thead th,tbody td{padding:0.3rem 0.35rem;} }
</style>
</head>
<body>
<header><h1>Path Wars</h1><p id="sub">Loading...</p></header>
<div class="ctr">
  <div id="loading">Loading archive data...</div>
  <div id="error">Could not load weekly_archive.json.</div>
  <div id="dash" style="display:none">
    <div class="summary-row">
      <div class="scard"><div class="val" id="sC">-</div><div class="lbl">Campaigns</div></div>
      <div class="scard"><div class="val" id="sP">-</div><div class="lbl">Posts This Week</div></div>
      <div class="scard"><div class="val" id="sA">-</div><div class="lbl">Active Players</div></div>
      <div class="scard"><div class="val" id="sG">-</div><div class="lbl">Avg Response Gap</div></div>
    </div>
    <div class="filter-bar"><label>Week:</label><select id="wf"></select></div>
    <div class="grid">
      <div class="card full"><h2>Total Posts per Week</h2><div class="chart-wrap"><canvas id="c1"></canvas></div></div>
      <div class="card"><h2>GM vs Player Split</h2><div class="chart-wrap"><canvas id="c2"></canvas></div></div>
      <div class="card"><h2>Response Gap Trend</h2><div class="chart-wrap"><canvas id="c3"></canvas></div><div class="legend-note">Lower = faster (hours between posts)</div></div>
      <div class="card full"><h2>Campaign Breakdown</h2><div style="overflow-x:auto"><table id="tbl"><thead><tr>
        <th data-k="campaign">Campaign</th><th data-k="total_posts" class="num">Total</th><th data-k="player_posts" class="num">Player</th>
        <th data-k="gm_posts" class="num">GM</th><th data-k="gap" class="num">Avg Gap</th><th data-k="players" class="num">Players</th>
        <th data-k="trend" class="num">Trend</th></tr></thead><tbody></tbody></table></div>
        <div class="legend-note">Click a campaign to see player breakdown</div></div>
    </div>
  </div>
</div>
<script>
const CL=['#d4a953','#6c8fd4','#d46c8f','#6cd4a0','#d4996c','#8f6cd4','#d4d46c','#6cd4d4','#c46cb8','#7ed46c'];
const DF={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#c8cad8',font:{family:"'Source Sans 3'",size:11}}}},scales:{x:{ticks:{color:'#7a7e96',font:{size:10}},grid:{color:'#2e335022'}},y:{ticks:{color:'#7a7e96',font:{size:10}},grid:{color:'#2e335044'},beginAtZero:true}}};
function hc(p){return p>=20?'hg':p>=10?'hy':p>=5?'ho':'hr';}
function tt(c,p){if(!p||p===0)return c>0?{c:'tu',t:'NEW'}:{c:'tf',t:'--'};const v=((c-p)/p*100);if(v>10)return{c:'tu',t:'+'+v.toFixed(0)+'%'};if(v<-10)return{c:'td',t:v.toFixed(0)+'%'};return{c:'tf',t:(v>=0?'+':'')+v.toFixed(0)+'%'};}

async function init(){
  let A;
  for(const p of['../data/weekly_archive.json','data/weekly_archive.json']){try{const r=await fetch(p);if(r.ok){A=await r.json();break;}}catch{}}
  if(!A){document.getElementById('loading').style.display='none';document.getElementById('error').style.display='block';return;}
  document.getElementById('loading').style.display='none';document.getElementById('dash').style.display='block';

  const E=Object.values(A),W=[...new Set(E.map(e=>e.week))].sort(),C=[...new Set(E.map(e=>e.campaign))].sort();
  const M={};E.forEach(e=>{M[e.campaign+':'+e.week]=e;});

  const wf=document.getElementById('wf');
  W.slice().reverse().forEach(w=>{const o=document.createElement('option');o.value=w;o.textContent=w;wf.appendChild(o);});
  let sw=W[W.length-1];

  function upd(){
    const pi=W.indexOf(sw)-1,pw=pi>=0?W[pi]:null;
    let tp=0,ta=0,gs=0,gc=0;
    C.forEach(c=>{const d=M[c+':'+sw]||{};tp+=d.total_posts||0;ta+=d.active_players||0;if(d.player_avg_gap_h!=null){gs+=d.player_avg_gap_h;gc++;}});
    document.getElementById('sC').textContent=C.length;
    document.getElementById('sP').textContent=tp.toLocaleString();
    document.getElementById('sA').textContent=ta;
    document.getElementById('sG').textContent=gc>0?(gs/gc).toFixed(1)+'h':'N/A';
    document.getElementById('sub').textContent=C.length+' campaigns · '+W.length+' weeks · Viewing '+sw;
    return pw;
  }

  const ch1=new Chart(document.getElementById('c1'),{type:'line',data:{labels:W,datasets:[]},options:DF});
  const ch2=new Chart(document.getElementById('c2'),{type:'bar',data:{labels:[],datasets:[]},options:{...DF,scales:{...DF.scales,x:{...DF.scales.x,stacked:true},y:{...DF.scales.y,stacked:true}}}});
  const ch3=new Chart(document.getElementById('c3'),{type:'line',data:{labels:W,datasets:[]},options:DF});

  function uc(){
    ch1.data.datasets=C.map((c,i)=>({label:c,data:W.map(w=>(M[c+':'+w]||{}).total_posts||0),borderColor:CL[i%CL.length],backgroundColor:CL[i%CL.length]+'33',tension:0.3,pointRadius:3,borderWidth:2}));ch1.update();
    const sn=C.map(c=>c.length>12?c.slice(0,10)+'..':c),wd=C.map(c=>M[c+':'+sw]||{});
    ch2.data.labels=sn;ch2.data.datasets=[{label:'Player',data:wd.map(d=>d.player_posts||0),backgroundColor:'#d46c8f'},{label:'GM',data:wd.map(d=>d.gm_posts||0),backgroundColor:'#6c8fd4'}];ch2.update();
    ch3.data.datasets=C.filter(c=>W.some(w=>(M[c+':'+w]||{}).player_avg_gap_h!=null)).map((c,i)=>({label:c,data:W.map(w=>{const d=M[c+':'+w];return d&&d.player_avg_gap_h!=null?d.player_avg_gap_h:null;}),borderColor:CL[i%CL.length],tension:0.3,pointRadius:3,spanGaps:true,borderWidth:2}));ch3.update();
  }

  const tb=document.querySelector('#tbl tbody');
  let sk='total_posts',sa=false,exp=null;

  function rt(pw){
    const data=C.map(c=>{const d=M[c+':'+sw]||{},p=pw?(M[c+':'+pw]||{}):{};const t=tt(d.total_posts||0,p.total_posts||0);return{campaign:c,total_posts:d.total_posts||0,player_posts:d.player_posts||0,gm_posts:d.gm_posts||0,gap:d.player_avg_gap_h,players:d.active_players||0,trend:t,tv:d.total_posts||0,pb:d.player_breakdown||{}};});
    data.sort((a,b)=>{let va=a[sk],vb=b[sk];if(sk==='trend'){va=a.tv;vb=b.tv;}if(va==null)va=-Infinity;if(vb==null)vb=-Infinity;if(typeof va==='string')return sa?va.localeCompare(vb):vb.localeCompare(va);return sa?va-vb:vb-va;});
    tb.innerHTML='';
    data.forEach(r=>{
      const g=r.gap!=null?r.gap.toFixed(1)+'h':'N/A';const o=exp===r.campaign;
      const tr=document.createElement('tr');tr.className='xp'+(o?' open':'');
      tr.innerHTML='<td class="cn"><span class="h '+hc(r.total_posts)+'"></span>'+r.campaign+'</td><td class="num">'+r.total_posts+'</td><td class="num">'+r.player_posts+'</td><td class="num">'+r.gm_posts+'</td><td class="num">'+g+'</td><td class="num">'+r.players+'</td><td class="num '+r.trend.c+'">'+r.trend.t+'</td>';
      tr.addEventListener('click',()=>{exp=exp===r.campaign?null:r.campaign;rt(pw);});
      tb.appendChild(tr);
      if(o&&Object.keys(r.pb).length>0){
        Object.entries(r.pb).map(([n,i])=>({name:n,...i})).sort((a,b)=>(b.posts||0)-(a.posts||0)).forEach(p=>{
          const pr=document.createElement('tr');pr.className='pr';
          const pg=p.avg_gap_h!=null?p.avg_gap_h.toFixed(1)+'h':'--';
          var sess=p.sessions!=null?p.sessions+' sessions':'';pr.innerHTML='<td>'+p.name+'</td><td class="num">'+(p.posts||0)+'</td><td class="num" colspan="2">'+sess+'</td><td class="num">'+pg+'</td><td class="num" colspan="2"></td>';
          tb.appendChild(pr);
        });
      }else if(o){const er=document.createElement('tr');er.className='pr';er.innerHTML='<td colspan="7" style="text-align:center;font-style:italic">No player breakdown for this week</td>';tb.appendChild(er);}
    });
    document.querySelectorAll('#tbl thead th').forEach(th=>{const k=th.dataset.k;th.classList.toggle('sorted',k===sk);const x=th.querySelector('.arrow');if(x)x.remove();if(k===sk){const a=document.createElement('span');a.className='arrow';a.textContent=sa?' ▲':' ▼';th.appendChild(a);}});
  }

  document.querySelectorAll('#tbl thead th').forEach(th=>{th.addEventListener('click',()=>{const k=th.dataset.k;if(k===sk)sa=!sa;else{sk=k;sa=k==='campaign';}rt(upd());});});
  wf.addEventListener('change',()=>{sw=wf.value;const pw=upd();uc();rt(pw);});
  const pw=upd();uc();rt(pw);
}
init();
</script>
</body>
</html>
